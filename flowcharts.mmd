flowchart TD

    %% ============================================
    %% 1. TOP-UP FLOW
    %% ============================================

    subgraph TOPUP["1. TOP-UP FLOW"]
        T1[Guardian/Member/Staff<br/>Request Top-up] --> T2{Select Payment Method}

        T2 -->|QRIS| T3A[Generate QRIS Code]
        T2 -->|Bank Transfer| T3B[Show Virtual Account]
        T2 -->|E-Wallet| T3C[Redirect to E-Wallet]
        T2 -->|Cash| T3D[Staff Manual Input]

        T3A --> T4[Create wallet_topup<br/>status: pending]
        T3B --> T4
        T3C --> T4
        T3D --> T4

        T4 --> T5{Payment Gateway<br/>Callback}

        T5 -->|Success| T6[Update wallet_topup<br/>status: completed]
        T5 -->|Failed| T7[Update wallet_topup<br/>status: failed]
        T5 -->|Expired| T8[Update wallet_topup<br/>status: expired]

        T6 --> T9[Create wallet_ledger<br/>entry_type: credit]
        T9 --> T10[Update wallet.balance]
        T10 --> T11[Send Notification<br/>to Guardian/Member]
        T11 --> T12[Create audit_log]

        T7 --> T13[Send Failed Notification]
        T8 --> T13
    end

    %% ============================================
    %% 2. PURCHASE FLOW
    %% ============================================

    subgraph PURCHASE["2. PURCHASE FLOW"]
        P1[Member Scan<br/>Fingerprint] --> P2{Fingerprint<br/>Verification}

        P2 -->|Success| P3[Get Member Info]
        P2 -->|Failed| P4{Attempts >= 3?}

        P4 -->|No| P1
        P4 -->|Yes| P5[Lock Fingerprint<br/>Show PIN Input]

        P5 --> P6{PIN Valid?}
        P6 -->|Yes| P3
        P6 -->|No| P7[Reject Transaction]

        P3 --> P8[Cashier Add Items<br/>to Cart]
        P8 --> P9[Calculate Total]

        P9 --> P10{Check Spending<br/>Limits}

        P10 -->|Within Limit| P11{Check Balance}
        P10 -->|Exceeded| P12[Show Limit Error<br/>Notify Guardian]

        P11 -->|Sufficient| P13[Create purchase<br/>status: completed]
        P11 -->|Insufficient| P14[Show Balance Error]

        P13 --> P15[Create purchase_items]
        P15 --> P16[Create wallet_ledger<br/>entry_type: debit]
        P16 --> P17[Update wallet.balance]
        P17 --> P18[Update menu_item.stock]
        P18 --> P19[Send Notification<br/>to Guardian]
        P19 --> P20[Print Receipt]
        P20 --> P21[Create audit_log]
    end

    %% ============================================
    %% 3. FINGERPRINT VERIFICATION FLOW
    %% ============================================

    subgraph FINGERPRINT["3. FINGERPRINT VERIFICATION"]
        F1[Receive Fingerprint<br/>Template from Device] --> F2{Check fingerprint<br/>is_active?}

        F2 -->|No| F3[Return: Fingerprint Disabled]
        F2 -->|Yes| F4{Check locked_until<br/>expired?}

        F4 -->|Still Locked| F5[Return: Fingerprint Locked<br/>Use PIN Instead]
        F4 -->|Not Locked| F6[Template Matching<br/>with stored template_hash]

        F6 --> F7{Match Found?}

        F7 -->|Yes| F8[Reset failed_attempts = 0]
        F7 -->|No| F9[Increment failed_attempts]

        F8 --> F10[Update last_verified_at]
        F10 --> F11[Return: Success<br/>member_id, wallet_id]

        F9 --> F12{failed_attempts >= 3?}

        F12 -->|Yes| F13[Set locked_until<br/>+15 minutes]
        F12 -->|No| F14[Return: Failed<br/>Try Again]

        F13 --> F15[Return: Locked<br/>Use PIN Instead]
    end

    %% ============================================
    %% 4. SPENDING LIMIT CHECK FLOW
    %% ============================================

    subgraph SPENDING["4. SPENDING LIMIT CHECK"]
        S1[Receive Purchase<br/>Request] --> S2[Get Active Limits<br/>for Wallet]

        S2 --> S3{Any Active<br/>Limits?}

        S3 -->|No| S4[Return: Approved]
        S3 -->|Yes| S5[Sort by Priority<br/>Highest First]

        S5 --> S6{Check Time Window<br/>allowed_start - allowed_end}

        S6 -->|Outside Window| S7[Return: Rejected<br/>Outside allowed time]
        S6 -->|Within Window| S8{Daily Spent + Amount<br/>within daily_limit?}

        S8 -->|Exceeded| S9[Return: Rejected<br/>Daily limit exceeded]
        S8 -->|Within| S10{Amount within<br/>per_transaction_limit?}

        S10 -->|Exceeded| S11[Return: Rejected<br/>Per tx limit exceeded]
        S10 -->|Within| S12{Check Item<br/>Categories}

        S12 -->|Blocked| S13[Return: Rejected<br/>Category not allowed]
        S12 -->|Allowed| S14[Return: Approved]
    end

    %% ============================================
    %% 5. OFFLINE TRANSACTION FLOW
    %% ============================================

    subgraph OFFLINE["5. OFFLINE TRANSACTION"]
        O1[Device Detects<br/>Network Offline] --> O2{Organization<br/>offline_mode_enabled?}

        O2 -->|No| O3[Show Error:<br/>Network Required]
        O2 -->|Yes| O4[Switch to<br/>Offline Mode]

        O4 --> O5[Member Scan<br/>Fingerprint]
        O5 --> O6[Verify with<br/>Cached Template]

        O6 --> O7{Match?}
        O7 -->|No| O8[Reject / Try PIN]
        O7 -->|Yes| O9[Get Cached<br/>Member Data]

        O9 --> O10{reserved_balance<br/>enough?}

        O10 -->|No| O11[Reject: Insufficient<br/>Offline Balance]
        O10 -->|Yes| O12[Create Local<br/>Transaction]

        O12 --> O13[Store in<br/>offline_transaction_queue]

        O13 --> O14[Deduct from<br/>Local reserved_balance]
        O14 --> O15[Print Offline<br/>Receipt]

        O15 --> O16[Device Comes<br/>Online]
        O16 --> O17[Sync Queue<br/>to Server]

        O17 --> O18{Server<br/>Validation}

        O18 -->|Valid| O19[Create Real Purchase<br/>sync_status: completed]
        O18 -->|Invalid| O20[sync_status: failed<br/>Alert Admin]

        O19 --> O21[Release reserved_balance]
        O21 --> O22[Send Notification]
    end

    %% ============================================
    %% 6. REFUND FLOW
    %% ============================================

    subgraph REFUND["6. REFUND FLOW"]
        R1[Cashier/Admin<br/>Request Refund] --> R2{Check Purchase<br/>Status}

        R2 -->|Already Refunded| R3[Return: Error]
        R2 -->|Completed| R4{Full or Partial?}

        R4 -->|Full| R5[refund_amount =<br/>final_amount]
        R4 -->|Partial| R6[Input refund_amount]

        R5 --> R7[status: refunded]
        R6 --> R8[status: partially_refunded]

        R7 --> R9[Create wallet_ledger<br/>type: refund]
        R8 --> R9

        R9 --> R10[Update wallet.balance]
        R10 --> R11[Restore stock]
        R11 --> R12[Send Notification]
        R12 --> R13[Create audit_log]
    end

    %% ============================================
    %% 7. MEMBER REGISTRATION FLOW
    %% ============================================

    subgraph REGISTRATION["7. MEMBER REGISTRATION"]
        REG1[Admin Input<br/>Member Data] --> REG2[Create member]

        REG2 --> REG3[Create wallet<br/>balance: 0]

        REG3 --> REG4[Enroll Fingerprint]

        REG4 --> REG5[Capture Template]
        REG5 --> REG6{Quality >= 60?}

        REG6 -->|No| REG7[Retry Capture]
        REG7 --> REG5

        REG6 -->|Yes| REG8[Encrypt & Store<br/>fingerprint]

        REG8 --> REG9{Set PIN?}

        REG9 -->|Yes| REG10[Hash PIN]
        REG9 -->|No| REG11[Skip]

        REG10 --> REG12[Link Guardian<br/>if School]
        REG11 --> REG12

        REG12 --> REG13[Create audit_log]
        REG13 --> REG14[Member Ready]
    end

    %% ============================================
    %% 8. LOW BALANCE ALERT
    %% ============================================

    subgraph LOWBALANCE["8. LOW BALANCE ALERT"]
        LB1[After Purchase] --> LB2{balance < threshold?}

        LB2 -->|No| LB3[No Action]
        LB2 -->|Yes| LB4[Get Guardian]

        LB4 --> LB5[Create notification<br/>type: low_balance]

        LB5 --> LB6{Channel}

        LB6 -->|Push| LB7[Send Push]
        LB6 -->|Email| LB8[Send Email]
        LB6 -->|SMS| LB9[Send SMS]

        LB7 --> LB10[status: sent]
        LB8 --> LB10
        LB9 --> LB10
    end
