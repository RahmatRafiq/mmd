erDiagram

    ORGANIZATION {
        uuid id PK
        string name "Organization name"
        string slug "UNIQUE - untuk URL"
        enum sector_type "school, industry, corporate, retail, government"
        string address
        string city
        string province
        string postal_code
        string phone
        string email "UNIQUE"
        string logo_url
        enum subscription_tier "trial, basic, premium, enterprise"
        datetime subscription_start
        datetime subscription_end
        boolean is_active
        json sector_settings "Sector-specific configuration"
        datetime created_at
        datetime updated_at
        datetime deleted_at
        uuid created_by FK "NULLABLE"
        uuid updated_by FK "NULLABLE"
        uuid deleted_by FK "NULLABLE"
    }

    USER {
        uuid id PK
        string username "UNIQUE"
        string email "UNIQUE"
        string password_hash
        boolean is_active
        datetime last_login_at
        datetime created_at
        datetime updated_at
        datetime deleted_at
        uuid created_by FK "NULLABLE"
        uuid updated_by FK "NULLABLE"
        uuid deleted_by FK "NULLABLE"
    }

    PROFILE {
        uuid id PK
        uuid user_id FK "UNIQUE - one profile per user"
        string name
        string phone "NULLABLE"
        string photo_url "NULLABLE"
        string address "NULLABLE"
        boolean is_public "Public or private profile"
        datetime created_at
        datetime updated_at
        uuid created_by FK "NULLABLE"
        uuid updated_by FK "NULLABLE"
    }

    STAFF {
        uuid id PK
        uuid user_id FK "UNIQUE"
        uuid organization_id FK "NULL untuk super_admin"
        enum staff_role "super_admin, org_admin, outlet_admin, cashier, hr_admin"
        boolean is_active
        datetime created_at
        datetime updated_at
        datetime deleted_at
        uuid created_by FK "NULLABLE"
        uuid updated_by FK "NULLABLE"
        uuid deleted_by FK "NULLABLE"
    }

    GUARDIAN {
        uuid id PK
        uuid user_id FK "UNIQUE"
        uuid organization_id FK
        string nik "NIK/KTP number - NULLABLE"
        boolean is_verified
        datetime email_verified_at "NULLABLE"
        datetime phone_verified_at "NULLABLE"
        datetime created_at
        datetime updated_at
        datetime deleted_at
        uuid created_by FK "NULLABLE"
        uuid updated_by FK "NULLABLE"
        uuid deleted_by FK "NULLABLE"
    }

    TENANT {
        uuid id PK
        uuid organization_id FK
        string name "Kantin Pusat, Cafeteria, Koperasi, Store"
        string slug "UNIQUE per organization"
        string location "Lantai 1 Gedung A, Floor 3"
        string description "NULLABLE"
        boolean is_active
        datetime created_at
        datetime updated_at
        datetime deleted_at
        uuid created_by FK "NULLABLE"
        uuid updated_by FK "NULLABLE"
        uuid deleted_by FK "NULLABLE"
        UNIQUE organization_id_slug
    }

    MEMBER {
        uuid id PK
        uuid user_id FK "NULLABLE - NULL for school, REQUIRED for industry"
        uuid organization_id FK
        string member_number "NIS/Employee ID - unique per org"
        string name
        string photo_url "NULLABLE"
        date birth_date "NULLABLE"
        enum gender "male, female, other"
        enum member_type "student, employee, worker, customer"
        boolean self_managed "true=industry, false=school"
        string grade "School: 7-12, Industry: NULL"
        string class_name "School: 7A, Industry: NULL"
        string department "School: NULL, Industry: IT/Finance/HR"
        string position "School: NULL, Industry: Manager/Staff"
        string address "NULLABLE"
        string phone "NULLABLE"
        string email "NULLABLE - industry: REQUIRED"
        boolean is_active
        datetime created_at
        datetime updated_at
        datetime deleted_at
        uuid created_by FK "NULLABLE"
        uuid updated_by FK "NULLABLE"
        uuid deleted_by FK "NULLABLE"
        UNIQUE organization_id_member_number
    }

    MEMBER_GUARDIAN {
        uuid id PK
        uuid member_id FK
        uuid guardian_id FK
        enum relationship "father, mother, grandfather, grandmother, sibling, uncle, aunt, guardian, emergency_contact, other"
        boolean is_primary "Only one primary guardian per member"
        boolean can_topup "Permission to topup wallet"
        boolean can_view_transactions "Permission to view purchase history"
        boolean can_set_limits "Permission to set spending limits"
        datetime created_at
        datetime updated_at
        uuid created_by FK "NULLABLE"
        uuid updated_by FK "NULLABLE"
        UNIQUE member_id_guardian_id
    }

    WALLET {
        uuid id PK
        uuid member_id FK
        enum wallet_type "main, savings, meal_allowance, transport"
        string wallet_name "NULLABLE - Uang Jajan, Tunjangan Makan"
        decimal balance "Current balance"
        string currency "IDR, USD"
        boolean is_primary "One primary wallet per member"
        boolean is_active
        boolean is_frozen "Frozen by admin/guardian/member"
        string frozen_reason "NULLABLE"
        datetime frozen_at "NULLABLE"
        datetime created_at
        datetime updated_at
        uuid created_by FK "NULLABLE"
        uuid updated_by FK "NULLABLE"
        UNIQUE member_id_wallet_type
    }

    WALLET_TOPUP {
        uuid id PK
        uuid wallet_id FK
        uuid organization_id FK "Denormalized for query performance"
        uuid topped_up_by_guardian_id FK "NULLABLE - for school sector"
        uuid topped_up_by_member_id FK "NULLABLE - for industry (self topup)"
        uuid topped_up_by_staff_id FK "NULLABLE - admin manual topup"
        string topup_code "UNIQUE - TU20251117001"
        decimal amount
        enum payment_method "bank_transfer, ewallet, qris, cash, payroll_deduction, bulk_transfer"
        string payment_reference "Reference dari payment gateway"
        enum status "pending, completed, failed, expired, refunded"
        json payment_metadata "Gateway response, receipt URL"
        datetime processed_at "NULLABLE"
        datetime refunded_at "NULLABLE"
        decimal refund_amount "NULLABLE"
        text refund_reason "NULLABLE"
        datetime created_at
        datetime updated_at
        uuid created_by FK "NULLABLE"
        uuid updated_by FK "NULLABLE"
        CHECK topped_up_by_one_not_null "Exactly one topped_up_by must be NOT NULL"
    }

    SPENDING_LIMIT {
        uuid id PK
        uuid wallet_id FK
        string limit_name "Uang Jajan Harian, Limit Weekend"
        decimal daily_limit "NULLABLE - NULL = no limit"
        decimal per_transaction_limit "NULLABLE"
        time allowed_start_time "NULLABLE - NULL = 00:00"
        time allowed_end_time "NULLABLE - NULL = 23:59"
        date effective_from "When this limit starts"
        date effective_until "NULLABLE - NULL = no end date"
        enum apply_on "all_days, weekdays, weekends, specific_dates"
        json specific_dates "NULLABLE - [2025-12-25, 2025-12-31]"
        int priority "Higher number = higher priority"
        json allowed_categories "NULLABLE - [makanan, minuman]"
        json blocked_categories "NULLABLE - [permen, soda]"
        boolean is_active
        datetime created_at
        datetime updated_at
        uuid created_by FK "NULLABLE"
        uuid updated_by FK "NULLABLE"
    }

    MENU_ITEM {
        uuid id PK
        uuid tenant_id FK
        string name "Nasi Goreng, Sandwich, Coffee"
        string sku "SKU - NULLABLE"
        text description "NULLABLE"
        decimal price
        string category "food, beverage, snack, stationery, merchandise"
        string image_url "NULLABLE"
        boolean is_available
        int stock_quantity "0 = unlimited if track_stock=false"
        boolean track_stock "Track inventory or not"
        int low_stock_threshold "Alert when stock below this"
        datetime created_at
        datetime updated_at
        datetime deleted_at
        uuid created_by FK "NULLABLE"
        uuid updated_by FK "NULLABLE"
        uuid deleted_by FK "NULLABLE"
    }

    PURCHASE {
        uuid id PK
        uuid member_id FK "Denormalized for query performance"
        uuid wallet_id FK
        uuid organization_id FK "Denormalized for reporting"
        uuid tenant_id FK
        uuid device_id FK "NULLABLE - manual purchase without device"
        uuid cashier_id FK "references STAFF(id)"
        string purchase_code "UNIQUE - PU20251117001"
        decimal total_amount "Total before discount"
        decimal discount_amount "NULLABLE - total discount"
        decimal final_amount "What member pays"
        enum status "completed, failed, refunded, partially_refunded"
        enum payment_method "wallet, cash, mixed"
        datetime purchase_time
        json verification_data "Fingerprint quality, device info"
        text notes "NULLABLE - cashier notes"
        datetime refunded_at "NULLABLE"
        decimal refund_amount "NULLABLE"
        text refund_reason "NULLABLE"
        datetime created_at
        datetime updated_at
        uuid created_by FK "NULLABLE - same as cashier_id"
        uuid updated_by FK "NULLABLE"
    }

    PURCHASE_ITEM {
        uuid id PK
        uuid purchase_id FK
        uuid menu_item_id FK
        string item_name "Snapshot - nama menu saat beli"
        string item_sku "NULLABLE"
        decimal item_price "Snapshot - harga saat beli"
        int quantity
        decimal subtotal "item_price * quantity"
        decimal discount_amount "NULLABLE - discount per item"
        datetime created_at
        uuid created_by FK "NULLABLE"
    }

    DEVICE {
        uuid id PK
        uuid organization_id FK
        uuid tenant_id FK "NULLABLE - device bisa org-level"
        string device_code "UNIQUE - DEV001"
        string device_serial
        enum device_type "fingerprint_scanner, pos_terminal, tablet, kiosk"
        string ip_address "NULLABLE"
        string mac_address "NULLABLE"
        enum status "active, inactive, maintenance, offline"
        datetime last_heartbeat_at
        json device_info "OS, app version, hardware specs"
        datetime created_at
        datetime updated_at
        uuid created_by FK "NULLABLE"
        uuid updated_by FK "NULLABLE"
    }

    FINGERPRINT {
        uuid id PK
        uuid member_id FK
        enum finger_position "thumb_left, thumb_right, index_left, index_right, middle_left, middle_right"
        blob encrypted_template "Encrypted biometric template"
        string template_hash "Hash for quick lookup"
        float quality_score "0-100"
        datetime enrolled_at
        datetime last_verified_at "Last time used"
        boolean is_active
        int failed_attempts "Failed verification attempts"
        datetime locked_until "NULLABLE - auto unlock after time"
        datetime created_at
        datetime updated_at
        uuid created_by FK "NULLABLE"
        uuid updated_by FK "NULLABLE"
        UNIQUE member_id_finger_position
    }

    NOTIFICATION {
        uuid id PK
        enum recipient_type "guardian, member, staff"
        uuid recipient_id "Polymorphic - guardian/member/staff.id"
        uuid organization_id FK "Denormalized for filtering"
        string title "Low Balance, Purchase Success"
        text message
        enum type "topup, purchase, low_balance, alert, limit_reached, refund, payroll"
        enum channel "in_app, email, sms, push"
        enum status "pending, sent, failed, read"
        boolean is_read
        datetime sent_at "NULLABLE"
        datetime read_at "NULLABLE"
        int retry_count "For failed deliveries"
        text error_message "NULLABLE - why delivery failed"
        json data "Additional context data"
        datetime created_at
        uuid created_by FK "NULLABLE"
    }

    %% Relationships
    ORGANIZATION ||--o{ STAFF : organization_id
    ORGANIZATION ||--o{ TENANT : organization_id
    ORGANIZATION ||--o{ GUARDIAN : organization_id
    ORGANIZATION ||--o{ MEMBER : organization_id
    ORGANIZATION ||--o{ DEVICE : organization_id

    USER ||--|| PROFILE : user_id
    USER ||--o| STAFF : user_id
    USER ||--o| GUARDIAN : user_id
    USER ||--o| MEMBER : user_id

    MEMBER ||--o{ MEMBER_GUARDIAN : member_id
    GUARDIAN ||--o{ MEMBER_GUARDIAN : guardian_id

    MEMBER ||--o{ WALLET : member_id
    WALLET ||--o{ WALLET_TOPUP : wallet_id
    WALLET ||--o{ PURCHASE : wallet_id
    WALLET ||--o{ SPENDING_LIMIT : wallet_id
    GUARDIAN ||--o{ WALLET_TOPUP : topped_up_by_guardian_id
    MEMBER ||--o{ WALLET_TOPUP : topped_up_by_member_id
    STAFF ||--o{ WALLET_TOPUP : topped_up_by_staff_id

    TENANT ||--o{ MENU_ITEM : tenant_id
    TENANT ||--o{ PURCHASE : tenant_id
    TENANT ||--o{ DEVICE : tenant_id

    PURCHASE ||--o{ PURCHASE_ITEM : purchase_id
    MENU_ITEM ||--o{ PURCHASE_ITEM : menu_item_id
    MEMBER ||--o{ PURCHASE : member_id
    STAFF ||--o{ PURCHASE : cashier_id
    DEVICE ||--o{ PURCHASE : device_id

    MEMBER ||--o{ FINGERPRINT : member_id

    GUARDIAN ||--o{ NOTIFICATION : recipient_id
    MEMBER ||--o{ NOTIFICATION : recipient_id
    STAFF ||--o{ NOTIFICATION : recipient_id
